var fs=require("fs"),url=require("url"),http=require("http"),request=require("request"),credentials=require("./_credentials"),extract_data=function(){fs.readFile("cache/drinks.json","utf8",function(e,n){var r=JSON.parse(n),i=[],t=[],o={},s=[],c=[],u={},a=[],l=[],d={},f=[];r.forEach(function(e){-1===t.indexOf(e.venue.venue_id)&&(i.push(e.venue),t.push(e.venue.venue_id)),o.hasOwnProperty(e.venue.venue_id)?o[e.venue.venue_id]+=1:o[e.venue.venue_id]=1,-1===c.indexOf(e.brewery.brewery_id)&&(s.push(e.brewery),c.push(e.brewery.brewery_id)),u.hasOwnProperty(e.brewery.brewery_id)?u[e.brewery.brewery_id]+=1:u[e.brewery.brewery_id]=1,-1===l.indexOf(e.beer.bid)&&(a.push(e.beer),l.push(e.beer.bid)),d.hasOwnProperty(e.beer.bid)?d[e.beer.bid]+=1:d[e.beer.bid]=1,f.push({beer:e.beer.bid,brewery:e.brewery.brewery_id,venue:e.venue.venue_id,time:e.created_at})}),i.forEach(function(e){e.count=o[e.venue_id]}),s.forEach(function(e){e.count=u[e.brewery_id]}),a.forEach(function(e){e.count=d[e.bid]}),fs.writeFile("venues.json",JSON.stringify(i),function(e){e&&console.log(e)}),fs.writeFile("breweries.json",JSON.stringify(s),function(e){e&&console.log(e)}),fs.writeFile("beers.json",JSON.stringify(a),function(e){e&&console.log(e)}),fs.writeFile("checkins.json",JSON.stringify(f),function(e){e&&console.log(e)})})},get_drinks=function(){var e=credentials.client_id,n=credentials.client_secret,r="https://api.untappd.com/v4/thepub/local/";fs.readFile("cache/drinks.json","utf8",function(i,t){var o=JSON.parse(t);console.log(o.length);var s=0;o.forEach(function(e){e.checkin_id>s&&(s=e.checkin_id)}),console.log(s);var c={lat:51.48,lng:-3.18,client_id:e,client_secret:n,radius:15,min_id:s};request({url:r,qs:c},function(e,n,i){if(e)return void console.log(e);var t=JSON.parse(i).response.checkins.items;console.log(o.length),o=o.concat(t),console.log(o.length);var u=!0;o.forEach(function(e){e.checkin_id>s&&(s=e.checkin_id)});for(var a=function(e,n,r){if(e)return void console.log(e);var i=JSON.parse(r).response.checkins.items;o=o.concat(i)},l=1;u&&99>l;){c.min_id=s,console.log(s),request({url:r,qs:c},a);var d=s;for(var f in o)o[f].checkin_id>s&&(s=o[f].checkin_id);console.log(s),d===s&&(u=!1),l+=1}console.log(o.length);var h=[],v=[];for(var p in o)o[p].checkin_id in v?h.push(p):"Bristol"===o[p].venue.location.venue_state||"Bristol"===o[p].venue.location.venue_city?h.push(p):"Somerset"===o[p].venue.location.venue_state||"North Somerset"===o[p].venue.location.venue_state?h.push(p):v.push(o[p].checkin_id);h.sort(function(e,n){return n-e});for(var _ in h)o.splice(h[_],1);console.log(o.length),fs.writeFile("cache/drinks.json",JSON.stringify(o),function(e){e&&console.log(e),extract_data()})})})}(),server=http.createServer(function(e,n){var r=url.parse(e.url,!0);if("/api/venues"===r.pathname){var i=new Date(r.query.iso),t={hour:i.getHours(),minute:i.getMinutes(),second:i.getSeconds()};n.writeHead(200,{"Content-Type":"application/json"}),n.end(JSON.stringify(t))}"/api/unixtime"===r.pathname&&(n.writeHead(200,{"Content-Type":"application/json"}),n.end(JSON.stringify({unixtime:new Date(r.query.iso).getTime()})))});