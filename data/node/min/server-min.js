var fs=require("fs"),url=require("url"),http=require("http"),schedule=require("node-schedule"),untappd=require("./untappd");schedule.scheduleJob("*/60 * * * *",function(){untappd.get_drinks(51.48,-3.18,15),untappd.extract_data(),console.log("checked drinks")});var checkin_subset=function(e,r,n){e=new Date(e),r=new Date(r);var t=[];fs.readFile("checkins.json","utf8",function(o,u){o&&(console.error(o),n(o));var s=JSON.parse(u);s.forEach(function(n){var o=new Date(n.time);o>=e&&r>=o&&t.push(n)}),n(null,t)})},return_subset=function(e,r,n,t){var o=[],u={};checkin_subset(r,n,function(r,n){r&&console.error(r),console.log(n.length),n.forEach(function(r){-1===o.indexOf(r[e])&&o.push(r[e]),u.hasOwnProperty(r[e])?u[r[e]]+=1:u[r[e]]=1}),console.log(o.length);var s;s="brewery"===e?"breweries.json":e+"s.json";var a;a="beer"===e?"bid":e+"_id",fs.readFile(s,"utf-8",function(e,r){var n=[],s=JSON.parse(r);s.forEach(function(e){-1!==o.indexOf(e[a])&&n.push(e)}),n.forEach(function(e){e.count=u[e[a]]}),t.writeHead(200,{"Content-Type":"application/json"}),t.end(r)})})},read_and_return=function(e,r){fs.readFile(e,"utf8",function(e,n){e&&console.error(e),r.writeHead(200,{"Content-Type":"application/json"}),r.end(n)})},server=http.createServer(function(e,r){var n=url.parse(e.url,!0),t=!1;n.query.hasOwnProperty("from")&&n.query.hasOwnProperty("to")&&(console.log(n.query.from),console.log(n.query.to),t=!0),"/api/venues"===n.pathname?t?return_subset("venue",n.query.from,n.query.to,r):read_and_return("venues.json",r):"/api/breweries"===n.pathname?t?return_subset("brewery",n.query.from,n.query.to,r):read_and_return("breweries.json",r):"/api/beers"===n.pathname?t?return_subset("beer",n.query.from,n.query.to,r):read_and_return("beers.json",r):"/api/checkins"===n.pathname&&(t?checkin_subset(n.query.from,n.query.to,function(e,n){r.writeHead(200,{"Content-Type":"application/json"}),r.end(JSON.stringify(n))}):read_and_return("checkins.json",r))});server.listen(2e3);