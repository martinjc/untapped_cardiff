var fs=require("fs"),request=require("request"),credentials=require("./_credentials");module.exports.extract_data=function(){fs.readFile("cache/drinks.json","utf8",function(e,n){if(e)return void console.error(e);var r=JSON.parse(n),i=[],o=[],s={},c=[],t=[],u={},l=[],a=[],d={},f=[];r.forEach(function(e){-1===o.indexOf(e.venue.venue_id)&&(i.push(e.venue),o.push(e.venue.venue_id)),s.hasOwnProperty(e.venue.venue_id)?s[e.venue.venue_id]+=1:s[e.venue.venue_id]=1,-1===t.indexOf(e.brewery.brewery_id)&&(c.push(e.brewery),t.push(e.brewery.brewery_id)),u.hasOwnProperty(e.brewery.brewery_id)?u[e.brewery.brewery_id]+=1:u[e.brewery.brewery_id]=1,-1===a.indexOf(e.beer.bid)&&(l.push(e.beer),a.push(e.beer.bid)),d.hasOwnProperty(e.beer.bid)?d[e.beer.bid]+=1:d[e.beer.bid]=1,f.push({beer:e.beer.bid,brewery:e.brewery.brewery_id,venue:e.venue.venue_id,time:e.created_at})}),i.forEach(function(e){e.count=s[e.venue_id]}),c.forEach(function(e){e.count=u[e.brewery_id]}),l.forEach(function(e){e.count=d[e.bid]}),fs.writeFile("venues.json",JSON.stringify(i),function(e){e&&console.error(e)}),fs.writeFile("breweries.json",JSON.stringify(c),function(e){e&&console.error(e)}),fs.writeFile("beers.json",JSON.stringify(l),function(e){e&&console.error(e)}),fs.writeFile("checkins.json",JSON.stringify(f),function(e){e&&console.error(e)})})},module.exports.get_drinks=function(e,n,r){var i=credentials.client_id,o=credentials.client_secret,s="https://api.untappd.com/v4/thepub/local/";fs.readFile("cache/drinks.json","utf8",function(c,t){var u=JSON.parse(t);console.log(new Date),console.log(u.length);var l=0;u.forEach(function(e){e.checkin_id>l&&(l=e.checkin_id)}),console.log(l);var a={lat:e,lng:n,client_id:i,client_secret:o,radius:r,min_id:l};request({url:s,qs:a},function(e,n,r){if(e)return void console.log(e);var i=JSON.parse(r).response.checkins.items;console.log(u.length),u=u.concat(i),console.log(u.length);var o=!0;u.forEach(function(e){e.checkin_id>l&&(l=e.checkin_id)});for(var c=function(e,n,r){if(e)return void console.log(e);var i=JSON.parse(r).response.checkins.items;u=u.concat(i)},t=1;o&&99>t;){a.min_id=l,console.log(l),request({url:s,qs:a},c);var d=l;for(var f in u)u[f].checkin_id>l&&(l=u[f].checkin_id);console.log(l),d===l&&(o=!1),t+=1}console.log(u.length);var v=[],h=[];for(var _ in u)u[_].checkin_id in h?v.push(_):"Bristol"===u[_].venue.location.venue_state||"Bristol"===u[_].venue.location.venue_city?v.push(_):"Somerset"===u[_].venue.location.venue_state||"North Somerset"===u[_].venue.location.venue_state?v.push(_):h.push(u[_].checkin_id);v.sort(function(e,n){return n-e});for(var b in v)u.splice(v[b],1);console.log(u.length),fs.writeFile("cache/drinks.json",JSON.stringify(u),function(e){e&&console.log(e)})})})};