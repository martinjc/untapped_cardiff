!function(){function e(){p=new WeekHandler,d.hasOwnProperty("from")&&d.hasOwnProperty("to")?(p.current_week.start=new Date(d.from),p.current_week.end=new Date(d.to)):d.hasOwnProperty("all")?(d3.select("#showall").attr("disabled","disabled"),t("")):d3.select("#today").attr("disabled","disabled");var e=p.get_query_string();t(e)}function a(){p.can_page_back()?d3.select("#previous").attr("disabled",null):d3.select("#previous").attr("disabled","disabled"),p.can_page_forward()?d3.select("#next").attr("disabled",null):d3.select("#next").attr("disabled","disabled")}function t(e){queue().defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/venues"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/breweries"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/beers"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/checkins"+e).await(function(e,t,d,n,s){t=JSON.parse(t.response),d=JSON.parse(d.response),n=JSON.parse(n.response),s=JSON.parse(s.response),e&&console.log(e);var u=Date.parse(s[0].time),w=u;s.forEach(function(e){var a=Date.parse(e.time);u>a&&(u=a),a>w&&(w=a)});var h=new Date(w).toDateString(),p=new Date(u).toDateString();d3.select("#from-date").text(p),d3.select("#to-date").text(h);var y=d3.nest().key(function(e){return e.beer_style}).rollup(function(e){return d3.sum(e,function(e){return e.count})}).entries(n);o.add_data(n,"beer_name","count","Number of checkins per beer",!0),c.add_data(d,"brewery_name","count","Number of checkins per brewery",!0),i.add_data(y,"key","values","Number of checkins per style",!0),l.add_data(t,"venue_name","count","Number of checkins per venue",!0),o.draw(),c.draw(),i.draw(),l.draw(),r(s),a()})}function r(e){function a(e){return(10>e?"0":"")+e+":00"}var t=[],r=[{day:"Sunday",count:0,days_seen:0,average:0},{day:"Monday",count:0,days_seen:0,average:0},{day:"Tuesday",count:0,days_seen:0,average:0},{day:"Wednesday",count:0,days_seen:0,average:0},{day:"Thursday",count:0,days_seen:0,average:0},{day:"Friday",count:0,days_seen:0,average:0},{day:"Saturday",count:0,days_seen:0,average:0}],d=[];for(var n in d3.range(0,24))d.push({time:a(n),count:0,average:0});e.forEach(function(e){var a=new Date(e.time),n=a.toDateString();-1===t.indexOf(n)&&(t.push(n),r[a.getDay()].days_seen+=1),r[a.getDay()].count+=1,d[a.getHours()].count+=1}),r.forEach(function(e){e.days_seen>0&&(e.average=e.count/e.days_seen)}),d.forEach(function(e){e.average=e.count/t.length}),u.add_data(r,"day","average","Average beers drunk per day",!1),w.add_data(d,"time","average","Average beers drunk per hour",!1),u.draw(),w.draw(),d3.xhr("http://bardiff-martinjc.rhcloud.com/api/checkins",function(e,a){a=JSON.parse(a.response),h.add_data(a),h.draw()})}var d,n;window.onpopstate=function(){var a,t=/\+/g,r=/([^&=]+)=?([^&]*)/g,s=function(e){return decodeURIComponent(e.replace(t," "))},o=window.location.search.substring(1);for(d={};null!==(a=r.exec(o));)d[s(a[1])]=s(a[2]);n=window.location.origin+window.location.pathname,e()},window.onpopstate();var s={top:10,bottom:140,left:90,right:10},o=new BarChart("#beers .vis",s),i=new BarChart("#styles .vis",s),c=new BarChart("#breweries .vis",s),l=new BarChart("#venues .vis",s),u=new BarChart("#day .vis",s),w=new BarChart("#time .vis",s),h=new DayChart("#year .vis");window.addEventListener("resize",function(){u.draw(),w.draw(),h.draw(),o.draw(),c.draw(),i.draw(),l.draw()});var p;d3.select("#previous").on("click",function(){d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled",null),p.can_page_back()&&(p.page_back(),window.history.pushState({},"",n+p.get_query_string()),t(p.get_query_string()))}),d3.select("#next").on("click",function(){d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled",null),p.can_page_forward()&&(p.page_forward(),window.history.pushState({},"",n+p.get_query_string()),t(p.get_query_string()))}),d3.select("#today").on("click",function(){d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled","disabled"),d3.select("#previous").attr("disabled",null),d3.select("#next").attr("disabled",null),window.history.pushState({},"",n),e()}),d3.select("#showall").on("click",function(){d3.select("#showall").attr("disabled","disabled"),d3.select("#today").attr("disabled",null),d3.select("#previous").attr("disabled","disabled"),d3.select("#next").attr("disabled","disabled"),window.history.pushState({all:"all"},"",n+"?all"),t("")})}();