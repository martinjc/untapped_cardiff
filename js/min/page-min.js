!function(){function e(){"thisweek"===u?(d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled","disabled"),d()):"all"===u?(d3.select("#showall").attr("disabled","disabled"),d3.select("#today").attr("disabled",null),d3.select("#previous").attr("disabled","disabled"),d3.select("#next").attr("disabled","disabled")):"previousweek"===u&&(d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled",null),d())}function a(e){var a,t=/\+/g,r=/([^&=]+)=?([^&]*)/g,n=function(e){return decodeURIComponent(e.replace(t," "))},d=window.location.search.substring(1);for(i={};null!==(a=r.exec(d));)i[n(a[1])]=n(a[2]);c=window.location.origin+window.location.pathname,e&&e()}function t(){a(),v=new WeekHandler,i.hasOwnProperty("from")&&i.hasOwnProperty("to")?(u="previousweek",v.current_week.start=new Date(i.from),v.current_week.end=new Date(i.to)):i.hasOwnProperty("all")?(u="all",o("")):u="thisweek";var t=v.get_query_string();e(),o(t)}function r(){u="previousweek",v.can_page_back()&&(v.page_back(),window.history.pushState({},"",c+v.get_query_string()),o(v.get_query_string())),e()}function n(){u="all",window.history.pushState({all:"all"},"",c+"?all=all"),o(""),e()}function d(){v.can_page_back()&&"all"!==u?d3.select("#previous").attr("disabled",null):d3.select("#previous").attr("disabled","disabled"),v.can_page_forward()&&"all"!==u?d3.select("#next").attr("disabled",null):d3.select("#next").attr("disabled","disabled")}function o(a){queue().defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/venues"+a).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/breweries"+a).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/beers"+a).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/checkins"+a).await(function(a,t,r,n,i){if(t=JSON.parse(t.response),r=JSON.parse(r.response),n=JSON.parse(n.response),i=JSON.parse(i.response),a&&console.log(a),0===i.length)return u="previousweek",v.can_page_back()&&(v.page_back(),window.history.pushState({},"",c+v.get_query_string()),o(v.get_query_string())),void e();var l=Date.parse(i[0].time),b=l;i.forEach(function(e){var a=Date.parse(e.time);l>a&&(l=a),a>b&&(b=a)});var p,_;if(window.innerWidth<760){var g=new Date(b);p=""+g.getDate()+"/"+(g.getMonth()+1)+"/"+g.getFullYear();var k=new Date(l);_=""+k.getDate()+"/"+(k.getMonth()+1)+"/"+k.getFullYear()}else p=new Date(b).toDateString(),_=new Date(l).toDateString();d3.select("#from-date").text(_),d3.select("#to-date").text(p);var m=d3.nest().key(function(e){return e.beer_style}).rollup(function(e){return d3.sum(e,function(e){return e.count})}).entries(n),D={};m.forEach(function(e){D[e.key]=[],n.forEach(function(a){a.beer_style===e.key&&D[e.key].push(a)}),D[e.key].sort(function(e,a){return e.count>a.count?-1:e.count<a.count?1:0}),D[e.key]=D[e.key].slice(0,10)});var S=function(e){var a="";return D[e.key].forEach(function(e,t){a+=""+(t+1)+". "+e.beer_name+" "+e.beer_abv+"% <br>"}),a},x=function(e){var a="";return a+="<img src='"+e.beer_label+"' width=40><br>"+e.beer_name+"<br>ABV: "+e.beer_abv+"%<br>Style: "+e.beer_style},N=function(e){var a="";return a+=e.venue_name+"<br>",e.contact.twitter&&(a+=e.contact.twitter+"<br>"),e.location.venue_address&&(a+=e.location.venue_address+"<br>"),e.location.venue_city&&(a+=e.location.venue_city),a},O=function(e){var a="";return a+="<img src='"+e.brewery_label+"' width=40><br>"+e.brewery_name+"<br>"+e.contact.url+"<br>@"+e.contact.twitter};w.add_data(n,"beer_name","count","Number of checkins per beer",!0,x),y.add_data(r,"brewery_name","count","Number of checkins per brewery",!0,O),h.add_data(m,"key","values","Number of checkins per style",!0,S),f.add_data(t,"venue_name","count","Number of checkins per venue",!0,N),w.draw(),y.draw(),h.draw(),f.draw(),s(i),d()})}function s(e){function a(e){return(10>e?"0":"")+e+":00"}var t=[],r=[{day:"Sunday",count:0,days_seen:0,average:0},{day:"Monday",count:0,days_seen:0,average:0},{day:"Tuesday",count:0,days_seen:0,average:0},{day:"Wednesday",count:0,days_seen:0,average:0},{day:"Thursday",count:0,days_seen:0,average:0},{day:"Friday",count:0,days_seen:0,average:0},{day:"Saturday",count:0,days_seen:0,average:0}],n=[];for(var d in d3.range(0,24))n.push({time:a(d),count:0,average:0});e.forEach(function(e){var a=new Date(e.time),d=a.toDateString();-1===t.indexOf(d)&&(t.push(d),r[a.getDay()].days_seen+=1),r[a.getDay()].count+=1,n[a.getHours()].count+=1}),r.forEach(function(e){e.days_seen>0&&(e.average=e.count/e.days_seen)}),n.forEach(function(e){e.average=e.count/t.length}),b.add_data(r,"day","average","Average beers drunk per day",!1,null),p.add_data(n,"time","average","Average beers drunk per hour",!1,null),b.draw(),p.draw(),d3.xhr("http://bardiff-martinjc.rhcloud.com/api/checkins",function(e,a){a=JSON.parse(a.response),_.add_data(a),_.draw()})}var i,c,u="thisweek";window.onpopstate=function(){a(t)},window.onpopstate();var l={top:10,bottom:140,left:90,right:10},w=new BarChart("#beers .vis",l),h=new BarChart("#styles .vis",l),y=new BarChart("#breweries .vis",l),f=new BarChart("#venues .vis",l),b=new BarChart("#day .vis",l),p=new BarChart("#time .vis",l),_=new DayChart("#year .vis");window.addEventListener("resize",function(){b.draw(),p.draw(),_.draw(),w.draw(),y.draw(),h.draw(),f.draw()});var v;d3.select("#previous").on("click",r),d3.select("#next").on("click",function(){v.can_page_forward()&&(v.page_forward(),window.history.pushState({},"",c+v.get_query_string()),o(v.get_query_string()),u=v.can_page_forward()?"previousweek":"thisweek"),e()}),d3.select("#today").on("click",function(){u="thisweek",window.history.pushState({},"",c),e(),t()}),d3.select("#showall").on("click",n)}();