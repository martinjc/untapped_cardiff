!function(){function e(){"thisweek"===i?(d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled","disabled"),r()):"all"===i?(d3.select("#showall").attr("disabled","disabled"),d3.select("#today").attr("disabled",null),d3.select("#previous").attr("disabled","disabled"),d3.select("#next").attr("disabled","disabled")):"previousweek"===i&&(d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled",null),r())}function a(e){var a,t=/\+/g,r=/([^&=]+)=?([^&]*)/g,n=function(e){return decodeURIComponent(e.replace(t," "))},d=window.location.search.substring(1);for(s={};null!==(a=r.exec(d));)s[n(a[1])]=n(a[2]);o=window.location.origin+window.location.pathname,e&&e()}function t(){a(),g=new WeekHandler,s.hasOwnProperty("from")&&s.hasOwnProperty("to")?(i="previousweek",g.current_week.start=new Date(s.from),g.current_week.end=new Date(s.to)):s.hasOwnProperty("all")?(i="all",n("")):i="thisweek";var t=g.get_query_string();e(),n(t)}function r(){g.can_page_back()?d3.select("#previous").attr("disabled",null):d3.select("#previous").attr("disabled","disabled"),g.can_page_forward()?d3.select("#next").attr("disabled",null):d3.select("#next").attr("disabled","disabled")}function n(e){queue().defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/venues"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/breweries"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/beers"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/checkins"+e).await(function(e,a,t,n,s){a=JSON.parse(a.response),t=JSON.parse(t.response),n=JSON.parse(n.response),s=JSON.parse(s.response),e&&console.log(e);var o=Date.parse(s[0].time),i=o;s.forEach(function(e){var a=Date.parse(e.time);o>a&&(o=a),a>i&&(i=a)});var c,p;if(window.innerWidth<760){var f=new Date(i);c=""+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear();var y=new Date(o);p=""+y.getDate()+"/"+(y.getMonth()+1)+"/"+y.getFullYear()}else c=new Date(i).toDateString(),p=new Date(o).toDateString();d3.select("#from-date").text(p),d3.select("#to-date").text(c);var g=d3.nest().key(function(e){return e.beer_style}).rollup(function(e){return d3.sum(e,function(e){return e.count})}).entries(n);l.add_data(n,"beer_name","count","Number of checkins per beer",!0),w.add_data(t,"brewery_name","count","Number of checkins per brewery",!0),u.add_data(g,"key","values","Number of checkins per style",!0),h.add_data(a,"venue_name","count","Number of checkins per venue",!0),l.draw(),w.draw(),u.draw(),h.draw(),d(s),r()})}function d(e){function a(e){return(10>e?"0":"")+e+":00"}var t=[],r=[{day:"Sunday",count:0,days_seen:0,average:0},{day:"Monday",count:0,days_seen:0,average:0},{day:"Tuesday",count:0,days_seen:0,average:0},{day:"Wednesday",count:0,days_seen:0,average:0},{day:"Thursday",count:0,days_seen:0,average:0},{day:"Friday",count:0,days_seen:0,average:0},{day:"Saturday",count:0,days_seen:0,average:0}],n=[];for(var d in d3.range(0,24))n.push({time:a(d),count:0,average:0});e.forEach(function(e){var a=new Date(e.time),d=a.toDateString();-1===t.indexOf(d)&&(t.push(d),r[a.getDay()].days_seen+=1),r[a.getDay()].count+=1,n[a.getHours()].count+=1}),r.forEach(function(e){e.days_seen>0&&(e.average=e.count/e.days_seen)}),n.forEach(function(e){e.average=e.count/t.length}),p.add_data(r,"day","average","Average beers drunk per day",!1),f.add_data(n,"time","average","Average beers drunk per hour",!1),p.draw(),f.draw(),d3.xhr("http://bardiff-martinjc.rhcloud.com/api/checkins",function(e,a){a=JSON.parse(a.response),y.add_data(a),y.draw()})}var s,o,i="thisweek";window.onpopstate=function(){a(t)},window.onpopstate();var c={top:10,bottom:140,left:90,right:10},l=new BarChart("#beers .vis",c),u=new BarChart("#styles .vis",c),w=new BarChart("#breweries .vis",c),h=new BarChart("#venues .vis",c),p=new BarChart("#day .vis",c),f=new BarChart("#time .vis",c),y=new DayChart("#year .vis");window.addEventListener("resize",function(){p.draw(),f.draw(),y.draw(),l.draw(),w.draw(),u.draw(),h.draw()});var g;d3.select("#previous").on("click",function(){i="previousweek",g.can_page_back()&&(g.page_back(),window.history.pushState({},"",o+g.get_query_string()),n(g.get_query_string())),e()}),d3.select("#next").on("click",function(){g.can_page_forward()&&(g.page_forward(),window.history.pushState({},"",o+g.get_query_string()),n(g.get_query_string()),i=g.can_page_forward()?"previousweek":"thisweek"),e()}),d3.select("#today").on("click",function(){i="thisweek",window.history.pushState({},"",o),e(),t()}),d3.select("#showall").on("click",function(){i="all",window.history.pushState({all:"all"},"",o+"?all=all"),n(""),e()})}();