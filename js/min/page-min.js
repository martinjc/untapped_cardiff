!function(){function e(){f=new WeekHandler;var e=f.get_query_string();r(e)}function a(){f.can_page_back()?d3.select("#previous").attr("disabled",null):d3.select("#previous").attr("disabled","disabled"),f.can_page_forward()?d3.select("#next").attr("disabled",null):d3.select("#next").attr("disabled","disabled")}function r(e){queue().defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/venues"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/breweries"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/beers"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/checkins"+e).await(function(e,r,n,i,u){r=JSON.parse(r.response),n=JSON.parse(n.response),i=JSON.parse(i.response),u=JSON.parse(u.response),e&&console.log(e);var l=Date.parse(u[0].time),f=l;u.forEach(function(e){var a=Date.parse(e.time);l>a&&(l=a),a>f&&(f=a)});var p=new Date(f).toDateString(),v=new Date(l).toDateString();d3.select("#from-date").text(v),d3.select("#to-date").text(p);var y=d3.nest().key(function(e){return e.beer_style}).rollup(function(e){return d3.sum(e,function(e){return e.count})}).entries(i);d.add_data(i,"beer_name","count","Number of checkins per beer",!0),c.add_data(n,"brewery_name","count","Number of checkins per brewery",!0),s.add_data(y,"key","values","Number of checkins per style",!0),o.add_data(r,"venue_name","count","Number of checkins per venue",!0),d.draw(),c.draw(),s.draw(),o.draw(),t(u),a()})}function t(e){function a(e){return(10>e?"0":"")+e+":00"}var r=[],t=[{day:"Sunday",count:0,days_seen:0,average:0},{day:"Monday",count:0,days_seen:0,average:0},{day:"Tuesday",count:0,days_seen:0,average:0},{day:"Wednesday",count:0,days_seen:0,average:0},{day:"Thursday",count:0,days_seen:0,average:0},{day:"Friday",count:0,days_seen:0,average:0},{day:"Saturday",count:0,days_seen:0,average:0}],n=[];for(var d in d3.range(0,24))n.push({time:a(d),count:0,average:0});e.forEach(function(e){var a=new Date(e.time),d=a.toDateString();-1===r.indexOf(d)&&(r.push(d),t[a.getDay()].days_seen+=1),t[a.getDay()].count+=1,n[a.getHours()].count+=1}),t.forEach(function(e){e.days_seen>0&&(e.average=e.count/e.days_seen)}),n.forEach(function(e){e.average=e.count/r.length}),i.add_data(t,"day","average","Average beers drunk per day",!1),u.add_data(n,"time","average","Average beers drunk per hour",!1),i.draw(),u.draw(),d3.xhr("http://bardiff-martinjc.rhcloud.com/api/checkins",function(e,a){a=JSON.parse(a.response),l.add_data(a),l.draw()})}var n={top:10,bottom:140,left:90,right:10},d=new BarChart("#beers .vis",n),s=new BarChart("#styles .vis",n),c=new BarChart("#breweries .vis",n),o=new BarChart("#venues .vis",n),i=new BarChart("#day .vis",n),u=new BarChart("#time .vis",n),l=new DayChart("#year .vis");window.addEventListener("resize",function(){i.draw(),u.draw(),l.draw(),d.draw(),c.draw(),s.draw(),o.draw()});var f;e(),d3.select("#previous").on("click",function(){console.log("clicked"),console.log(f.can_page_back()),f.can_page_back()&&(f.page_back(),r(f.get_query_string()))}),d3.select("#next").on("click",function(){f.can_page_forward()&&(f.page_forward(),r(f.get_query_string()))}),d3.select("#today").on("click",function(){d3.select("#previous").attr("disabled",null),d3.select("#next").attr("disabled",null),e()}),d3.select("#showall").on("click",function(){d3.select("#previous").attr("disabled","disabled"),d3.select("#next").attr("disabled","disabled"),r("")})}();