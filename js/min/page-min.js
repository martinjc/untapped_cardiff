!function(){function e(e){var a,t=/\+/g,r=/([^&=]+)=?([^&]*)/g,d=function(e){return decodeURIComponent(e.replace(t," "))},o=window.location.search.substring(1);for(n={};null!==(a=r.exec(o));)n[d(a[1])]=d(a[2]);s=window.location.origin+window.location.pathname,e&&e()}function a(){e(),y=new WeekHandler,n.hasOwnProperty("from")&&n.hasOwnProperty("to")?(y.current_week.start=new Date(n.from),y.current_week.end=new Date(n.to),d3.select("#today").attr("disabled",null),d3.select("#showall").attr("disabled",null)):n.hasOwnProperty("all")?(d3.select("#showall").attr("disabled","disabled"),r("")):d3.select("#today").attr("disabled","disabled");var a=y.get_query_string();r(a)}function t(){y.can_page_back()?d3.select("#previous").attr("disabled",null):d3.select("#previous").attr("disabled","disabled"),y.can_page_forward()?d3.select("#next").attr("disabled",null):d3.select("#next").attr("disabled","disabled")}function r(e){queue().defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/venues"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/breweries"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/beers"+e).defer(d3.xhr,"http://bardiff-martinjc.rhcloud.com/api/checkins"+e).await(function(e,a,r,n,s){a=JSON.parse(a.response),r=JSON.parse(r.response),n=JSON.parse(n.response),s=JSON.parse(s.response),e&&console.log(e);var o=Date.parse(s[0].time),w=o;s.forEach(function(e){var a=Date.parse(e.time);o>a&&(o=a),a>w&&(w=a)});var h,p;if(window.innerWidth<760){var y=new Date(w);h=""+y.getDate()+"/"+(y.getMonth()+1)+"/"+y.getFullYear();var f=new Date(o);p=""+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()}else h=new Date(w).toDateString(),p=new Date(o).toDateString();d3.select("#from-date").text(p),d3.select("#to-date").text(h);var b=d3.nest().key(function(e){return e.beer_style}).rollup(function(e){return d3.sum(e,function(e){return e.count})}).entries(n);i.add_data(n,"beer_name","count","Number of checkins per beer",!0),c.add_data(r,"brewery_name","count","Number of checkins per brewery",!0),l.add_data(b,"key","values","Number of checkins per style",!0),u.add_data(a,"venue_name","count","Number of checkins per venue",!0),i.draw(),c.draw(),l.draw(),u.draw(),d(s),t()})}function d(e){function a(e){return(10>e?"0":"")+e+":00"}var t=[],r=[{day:"Sunday",count:0,days_seen:0,average:0},{day:"Monday",count:0,days_seen:0,average:0},{day:"Tuesday",count:0,days_seen:0,average:0},{day:"Wednesday",count:0,days_seen:0,average:0},{day:"Thursday",count:0,days_seen:0,average:0},{day:"Friday",count:0,days_seen:0,average:0},{day:"Saturday",count:0,days_seen:0,average:0}],d=[];for(var n in d3.range(0,24))d.push({time:a(n),count:0,average:0});e.forEach(function(e){var a=new Date(e.time),n=a.toDateString();-1===t.indexOf(n)&&(t.push(n),r[a.getDay()].days_seen+=1),r[a.getDay()].count+=1,d[a.getHours()].count+=1}),r.forEach(function(e){e.days_seen>0&&(e.average=e.count/e.days_seen)}),d.forEach(function(e){e.average=e.count/t.length}),w.add_data(r,"day","average","Average beers drunk per day",!1),h.add_data(d,"time","average","Average beers drunk per hour",!1),w.draw(),h.draw(),d3.xhr("http://bardiff-martinjc.rhcloud.com/api/checkins",function(e,a){a=JSON.parse(a.response),p.add_data(a),p.draw()})}var n,s;window.onpopstate=function(){e(a)},window.onpopstate();var o={top:10,bottom:140,left:90,right:10},i=new BarChart("#beers .vis",o),l=new BarChart("#styles .vis",o),c=new BarChart("#breweries .vis",o),u=new BarChart("#venues .vis",o),w=new BarChart("#day .vis",o),h=new BarChart("#time .vis",o),p=new DayChart("#year .vis");window.addEventListener("resize",function(){w.draw(),h.draw(),p.draw(),i.draw(),c.draw(),l.draw(),u.draw()});var y;d3.select("#previous").on("click",function(){d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled",null),y.can_page_back()&&(y.page_back(),window.history.pushState({},"",s+y.get_query_string()),r(y.get_query_string()))}),d3.select("#next").on("click",function(){d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled",null),y.can_page_forward()&&(y.page_forward(),window.history.pushState({},"",s+y.get_query_string()),r(y.get_query_string()))}),d3.select("#today").on("click",function(){d3.select("#showall").attr("disabled",null),d3.select("#today").attr("disabled","disabled"),d3.select("#previous").attr("disabled",null),d3.select("#next").attr("disabled",null),window.history.pushState({},"",s),a()}),d3.select("#showall").on("click",function(){d3.select("#showall").attr("disabled","disabled"),d3.select("#today").attr("disabled",null),d3.select("#previous").attr("disabled","disabled"),d3.select("#next").attr("disabled","disabled"),window.history.pushState({all:"all"},"",s+"?all"),r("")})}();