var width,height,padding={top:10,bottom:140,left:100,right:20},transition_duration=2e3,do_year=function(t){function e(t){return 0===t?"Jan":1===t?"Feb":2===t?"Mar":3===t?"Apr":4===t?"May":5===t?"Jun":6===t?"Jul":7===t?"Aug":8===t?"Sep":9===t?"Oct":10===t?"Nov":11===t?"Dec":void 0}function a(t){var e=new Date(t.getFullYear(),t.getMonth()+1,0),a=+r(t),n=+i(t),d=+r(e),o=+i(e);return"M"+(n+1)*u+","+a*u+"H"+n*u+"V"+7*u+"H"+o*u+"V"+(d+1)*u+"H"+(o+1)*u+"V0H"+(n+1)*u+"Z"}var n={},r=d3.time.format("%w"),i=d3.time.format("%U"),d=d3.format(".1%"),o=d3.time.format("%Y-%m-%d"),s=d3.scale.quantile().range(colorbrewer.Reds[9]),l=document.getElementById("day_box");l=l.getElementsByClassName("vis")[0],width=l.clientWidth,height=l.clientHeight,height-=padding.bottom;var u=width/60,g=d3.select("#day_box .vis").selectAll("svg").data([2015]).enter().append("svg").attr("height",height+padding.top+padding.bottom).attr("width",width);g.append("text").attr("transform","translate(-6,"+3.5*u+")rotate(-90)").style("text-anchor","middle").text(function(t){return t});var h=g.selectAll(".day").data(function(t){return d3.time.days(new Date(t,0,1),new Date(t+1,0,1))}).enter().append("rect").attr("class","day").attr("fill","none").attr("stroke","#ccc").attr("width",u).attr("height",u).attr("x",function(t){return i(t)*u}).attr("y",function(t){return r(t)*u}).datum(o);h.append("title").text(function(t){return t});var f=g.selectAll(".month").data(function(t){return d3.time.months(new Date(t,0,1),new Date(t+1,0,1))}).enter().append("g").attr("class","month");f.append("path").attr("d",a),f.append("text").text(function(t){return e(t.getMonth())}).attr("x",function(t){return w0=+i(t),(w0+1)*u}).attr("y",function(t){return 8*u});for(c in t)date=new Date(t[c].time),date=date.toDateString(),n[date]=date in n?n[date]+1:1;var y=0;for(date in n)n[date]>y&&(y=n[date]);s.domain([1,y]),h.filter(function(t){return new Date(t).toDateString()in n}).attr("fill",function(t){return s(n[new Date(t).toDateString()])})},calc_time=function(t){function e(t){return(10>t?"0":"")+t+":00"}days_seen=[];var a=[{day:"Sunday",count:0,days_seen:0,average:0},{day:"Monday",count:0,days_seen:0,average:0},{day:"Tuesday",count:0,days_seen:0,average:0},{day:"Wednesday",count:0,days_seen:0,average:0},{day:"Thursday",count:0,days_seen:0,average:0},{day:"Friday",count:0,days_seen:0,average:0},{day:"Saturday",count:0,days_seen:0,average:0}],n=d3.range(0,23),n=[];for(i in d3.range(0,24))n.push({time:e(i),count:0,average:0});t.forEach(function(t){d=new Date(t.time),d_string=d.toDateString(),-1===days_seen.indexOf(d_string)&&(days_seen.push(d_string),a[d.getDay()].days_seen+=1),a[d.getDay()].count+=1,n[d.getHours()].count+=1}),a.forEach(function(t){t.average=t.count/t.days_seen}),n.forEach(function(t){t.average=t.count/days_seen.length}),draw_plot("day",a,"average","day",!1,"Average beers drunk per day"),draw_plot("hour",n,"average","time",!1,"Average beers drunk per hour")},draw_plot=function(t,e,a,n,r,i){var d=document.getElementById(t);d=d.getElementsByClassName("vis")[0],width=d.clientWidth,height=d.clientHeight,height-=padding.bottom,max_bars=400>width?10:width>400&1e3>width?15:20;var o,s=d3.scale.quantile().range(colorbrewer.Reds[9]),l=d3.scale.ordinal(),u=d3.scale.linear().nice(),c=d3.svg.axis().scale(l).orient("bottom").ticks(8),g=d3.svg.axis().scale(u).orient("left").ticks(8);l.rangeRoundBands([padding.left,width-padding.right],.1),u.range([height,padding.top]),o=d3.select("#"+t+" .vis").append("svg").attr("height",height+padding.top+padding.bottom).attr("width",width),o.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")"),o.append("g").attr("class","y axis").attr("transform","translate("+padding.left+",0)"),r&&(e.sort(function(t,e){return t[a]>e[a]?-1:t[a]<e[a]?1:0}),e=e.slice(0,max_bars)),bars=o.selectAll(".bar").data(e),bars.enter().append("rect").attr("x",function(t){return l(t[n])}).attr("y",height).attr("width",l.rangeBand()).attr("height",0).attr("fill",function(t){return s(t[a])}).attr("class","bar"),bars.transition().duration(transition_duration).attr("y",function(t){return u(t[a])}).attr("height",function(t){return height-u(t[a])}),bars.exit().transition().duration(transition_duration).attr("y",height).attr("height",0).remove(),o.select(".x.axis").transition().duration(transition_duration).call(c).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform",function(t){return"rotate(-35)"}),o.select(".y.axis").transition().duration(transition_duration).call(g),o.select(".y.axis").append("text").attr("class","y label").attr("text-anchor","end").attr("dx","-4em").attr("dy","-3.5em").attr("transform","rotate(-90)").text(i)},init=function(){queue().defer(d3.json,"data/venues.json").defer(d3.json,"data/breweries.json").defer(d3.json,"data/beers.json").defer(d3.json,"data/checkins.json").await(function(t,a,n,r,i){console.log(a),console.log(n),console.log(r),console.log(i),styles=d3.nest().key(function(t){return t.beer_style}).rollup(function(t){return d3.sum(t,function(t){return t.count})}).entries(r),console.log(styles),earliest=Date.parse(i[0].time),latest=earliest,i.forEach(function(t){var e=Date.parse(t.time);e<earliest&&(earliest=e),e>latest&&(latest=e)}),l=new Date(latest),e=new Date(earliest),l_string=l.toDateString(),e_string=e.toDateString(),d3.select("#from-date").text(e_string),d3.select("#to-date").text(l_string),draw_plot("where",a,"count","venue_name",!0,"Number of beers drunk at Venue"),draw_plot("breweries",n,"count","brewery_name",!0,"Number of beers drunk from brewery"),draw_plot("beers",r,"count","beer_name",!0,"Number of checkins per beer"),draw_plot("styles",styles,"values","key",!0,"Number of beers drunk per style"),calc_time(i),do_year(i)})}();