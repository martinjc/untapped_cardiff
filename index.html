<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <title>Drinking in the 'Diff</title>

    <!-- Styles -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/style.css">
    

    <!-- Good at all sizes! -->
    <meta name=viewport content="width=device-width, initial-scale=1">

</head>
<body>
    <header>
        <h1>Drinking in the Diff!</h1>
    </header>

    <div id="main">

        <!-- intro should always be top of the page -->
        <section id="intro" class="flex-item text-box">
            <p>This page shows details of the beer drinking activity that happened in Cardiff, according to the beer-based social network/logging app <a href="https://untappd.com/home">Untappd</a>.</p>
        <!-- #intro -->
        </section>

        <!-- dashboard presents the data -->
        <section id="dashboard">

            <section id="change-dates">
                <h2>Dates Displayed</h2>
                <form>
                    <input type="button" name="previous" value="<">
                    <span class="bold" id="from-date"></span> To <span class="bold" id="to-date"></span>
                    <input type="button" name="next" value = ">">
                    <input type="button" name="show all" value="Show All">
                </form>
            </section>

            <section id="what">
                <h2>What's been drunk?</h2>
                <div id="styles">
                    <h3>Styles</h3>
                    <div class="vis"></div>
                </div>
                <div id="beers">
                    <h3>Beers</h3>
                    <div class="vis"></div>
                </div>
                <div id="breweries">
                    <h3>Breweries</h3>
                    <div class="vis"></div>
                </div>
            </section>

            <section id="where">
                <h2>Where's it been drunk?</h2>
                <div id="venues">
                    <h3>Venues</h3>
                    <div class="vis"></div>
                </div>
                
            </section>

            <section id="when">
                <h2>When's it been drunk?</h2>
                <div id="day">
                    <h3>Day</h3>
                    <div class="vis"></div>
                </div>
                <div id="time">
                    <h3>Time</h3>
                    <div class="vis"></div>
                </div>
                <div id="year">
                    <h3>2015</h3>
                    <div class="vis"></div>
                </div>
            </section>
        
        <!-- dashboard -->
        </section>

        <!-- data description is top of page on larger screens, bottom of page on smaller -->
        <section id="data-description" class="flex-item text-box">
            <p>All data comes from Untappd's 'local' feed, so only includes beer checkins that have a venue attached. Want to influence these stats? Sign up for <a href="https://untappd.com/home">Untappd</a> and checkin your beers! <small>(Want to influence these stats but not give away your location? Try checking in with your neighbourhood as the venue.)</small></p>
        </section>

    <!-- main -->
    </div>

    <footer>
        <div id="description" class="flex-item text-box">
            <small class="description">Created by <a href="http://www.twitter.com/martinjc">@martinjc</a> for no other reason than he had an <a href="https://untappd.com/home">Untappd</a> API key that wasn't getting used. Find him on Untappd <a href="https://untappd.com/user/martinjc">here</a>. Some of the beers above were drunk by him, this much is guaranteed.</small> 
        </div>
        <div id="untappd-logo" class="flex-item text-box">
            <a href="https://untappd.com/home"><img class="utplogo" src="img/pbu_320_black.png"></a>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script src="http://d3js.org/colorbrewer.v1.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="js/min/vis-min.js"></script>
    <script>

        var padding = {
            top: 10,
            bottom: 140,
            left: 90,
            right: 10
        };

        beer_chart = new BarChart("#beers .vis", padding);
        styles_chart = new BarChart("#styles .vis", padding);
        breweries_chart = new BarChart("#breweries .vis", padding);
        venues_chart = new BarChart("#venues .vis", padding);
        day_chart = new BarChart("#day .vis", padding);
        time_chart = new BarChart("#time .vis", padding);
        year_chart = new DayChart("#year .vis");

        queue()
            .defer(d3.xhr, "http://bardiff-martinjc.rhcloud.com/api/venues")
            .defer(d3.xhr, "http://bardiff-martinjc.rhcloud.com/api/breweries")
            .defer(d3.xhr, "http://bardiff-martinjc.rhcloud.com/api/beers")
            .defer(d3.xhr, "http://bardiff-martinjc.rhcloud.com/api/checkins")
            .await(function(error, venues, breweries, beers, checkins){

                venues = JSON.parse(venues.response);
                breweries = JSON.parse(breweries.response);
                beers = JSON.parse(beers.response);
                checkins = JSON.parse(checkins.response);

                if(error) {
                    console.log(errorr);
                }

                earliest = Date.parse(checkins[0].time);
                latest = earliest;
                checkins.forEach(function(d) {
                    var t = Date.parse(d.time);
                    if(t < earliest) {
                        earliest = t;
                    }
                    if(t > latest) {
                        latest = t;
                    }
                })

                l = new Date(latest);
                e = new Date(earliest);

                l_string = l.toDateString();
                e_string = e.toDateString();

                d3.select('#from-date').text(e_string);
                d3.select('#to-date').text(l_string);

                styles = d3.nest()
                .key(function(d) {
                  return d.beer_style;
                })
                .rollup(function(d) {
                  return d3.sum(d, function(g) {
                    return g.count;
                  });
                })
                .entries(beers);


                beer_chart.add_data(beers, "beer_name", "count", "Number of checkins per beer", true);
                breweries_chart.add_data(breweries, "brewery_name", "count", "Number of checkins per brewery", true);
                styles_chart.add_data(styles, "key", "values", "Number of checkins per style", true);
                venues_chart.add_data(venues, "venue_name", "count", "Number of checkins per venue", true);
                beer_chart.draw();
                breweries_chart.draw();
                styles_chart.draw();
                venues_chart.draw();
                calc_time(checkins);
            });

        var calc_time = function(checkins) {

            function zero(time) {
                return (time < 10 ? "0" : "") + time +  ":00";
            }

            days_seen = [];

            var days = [
            {'day': 'Sunday', 'count': 0, 'days_seen': 0, 'average': 0},
            {'day': 'Monday', 'count': 0, 'days_seen': 0, 'average': 0},
            {'day': 'Tuesday', 'count': 0, 'days_seen': 0, 'average': 0},
            {'day': 'Wednesday', 'count': 0, 'days_seen': 0, 'average': 0},
            {'day': 'Thursday', 'count': 0, 'days_seen': 0, 'average': 0},
            {'day': 'Friday', 'count': 0, 'days_seen': 0, 'average': 0}, 
            {'day': 'Saturday', 'count': 0, 'days_seen': 0, 'average': 0},
            ]
            var times = d3.range(0, 23);

            var times = []
            for(i in d3.range(0, 24)) {
                times.push({'time': zero(i), 'count': 0, 'average': 0});
            }

            checkins.forEach(function(c) {
                d = new Date(c.time);
                d_string = d.toDateString();
                if(days_seen.indexOf(d_string) === -1) {
                    days_seen.push(d_string);
                    days[d.getDay()].days_seen +=1;
                }
                days[d.getDay()].count += 1;
                times[d.getHours()].count += 1;
            });

            days.forEach(function(d) {
                d.average = d.count / d.days_seen;
            });

            times.forEach(function(t) {
                t.average = t.count / days_seen.length;
            })

            day_chart.add_data(days, 'day', 'average', 'Average beers drunk per day', false);
            time_chart.add_data(times, 'time', 'average', 'Average beers drunk per hour', false);
            year_chart.add_data(checkins);
            day_chart.draw();
            time_chart.draw();
            year_chart.draw();

        }

        window.addEventListener("resize", function(){
            day_chart.draw();
            time_chart.draw();
            year_chart.draw();            
            beer_chart.draw();
            breweries_chart.draw();
            styles_chart.draw();
            venues_chart.draw();
        }) 
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-61995316-1', 'auto');
      ga('send', 'pageview');

    </script>
</body>
</html>