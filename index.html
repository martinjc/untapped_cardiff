<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Beer the 'Diff</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script src="http://d3js.org/colorbrewer.v1.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <style>
        html, body {
            margin: 0px;
            padding: 0px;
            height: 100%;
            width: 100%;
        }

        #venues, #breweries, #beers, #styles {
            width: 50%;
            height: 400px;
            margin-bottom: 30px;
        }

        #venues, #breweries {
            float: left;
        }

        #beers, #styles {
            float: right;
        }

        .vis {
            width: 100%;
            height: 100%;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }
        
        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }

    </style>
</head>
<body>
    <section id="venues">
        <h1>Venues</h1>
        <div class="vis"></div>
    </section>
    <section id="breweries">
        <h1>Breweries</h1>
        <div class="vis"></div>
    </section>
    <section id="styles">
        <h1>Styles</h1>
        <div class="vis"></div>
    </section>
    <section id="beers">
        <h1>Beers</h1>
        <div class="vis"></div>
    </section>
    <script>

        // the width and height of the visualisation
        var width;
        var height;

        var padding = {
            top: 30,
            bottom: 150,
            left: 100,
            right: 20
        }

        var transition_duration = 2000;

        var draw_plot = function(element, data, value_label, x_label) {

            var g = document.getElementById(element);
            g = g.getElementsByClassName("vis")[0];
            width = g.clientWidth;
            height = g.clientHeight;
            height = height - padding.bottom;

            console.log(height);
            console.log(width);

            // the svg element that will hold the visualisation
            var svg;

            // a scale of colours
            var colour_scale = d3.scale.quantile().range(colorbrewer.YlGnBu[9]);

            // define x-scale and y-scale
            var x_scale = d3.scale.ordinal();
            var y_scale = d3.scale.linear();

            // define xaxis
            var x_axis = d3.svg.axis()
              .scale(x_scale)
              .orient("bottom")
              .ticks(8);

            // define Y axis
            var y_axis = d3.svg.axis()
              .scale(y_scale)
              .orient("left")
              .ticks(8);

            x_scale.rangeRoundBands([padding.left, width-padding.right], 0.1);
            y_scale.range([height, padding.top]);

            svg = d3.select("#" + element + " .vis")
                .append("svg")
                .attr("height", height+padding.top+padding.bottom)
                .attr("width", width);

            // svg.append("rect")
            //     .attr("height", height+padding.top+padding.bottom)
            //     .attr("width", width)
            //     .attr("fill", "#eee");

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")");

            svg.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + padding.left + ",0)");

            console.log(data);

            data.sort(function(a, b){
                if (a[value_label] > b[value_label]) {
                    return -1;
                }
                if (a[value_label] < b[value_label]) {
                    return 1;
                }
                return 0;
            })

            console.log(data);

            data = data.slice(0,20);

            var names = data.map(function(d){ return d[x_label]; });
            console.log(names);

            var largest_data_value = d3.max(data, function(d){ return d[value_label]; })

            x_scale.domain(names);
            y_scale.domain([0, largest_data_value]);
            colour_scale.domain([0, largest_data_value]);

            var bars = svg
                .selectAll(".bar")
                .data(data);               

            bars
                .enter()
                .append("rect")
                .attr("x", function(d){ return x_scale(d[x_label]); })
                .attr("y", height)
                .attr("width", x_scale.rangeBand())
                .attr("height", 0 )
                .attr("fill", function(d) {
                    return colour_scale(d[value_label]);
                })
                .attr("class", "bar");

            bars       
                .transition()
                .duration(transition_duration)
                .attr("y", function(d){ return y_scale(d[value_label]); })
                .attr("height", function(d){ return height - y_scale(d[value_label])})

            bars
                .exit()
                .transition()
                .duration(transition_duration)
                .attr("y", height)
                .attr("height", 0)
                .remove();

            // create x-axis
            svg.select(".x.axis")
                .transition()
                .duration(transition_duration)
                .call(x_axis)
                .selectAll("text")  
                    .style("text-anchor", "end")
                    //.attr("dx", "-.8em")
                    //.attr("dy", ".15em")
                    .attr("transform", function(d) {
                        return "rotate(-35)" 
                    });
            
            // create y-axis
            svg.select(".y.axis")
                .transition()
                .duration(transition_duration)
                .call(y_axis);
        }

        var init = function() { 
            queue()
                .defer(d3.json, "data/venues.json")
                .defer(d3.json, "data/breweries.json")
                .defer(d3.json, "data/beers.json")
                .defer(d3.json, "data/checkins.json")
                .await(function(error, venues, breweries, beers, checkins){
                    console.log(venues);
                    console.log(breweries);
                    console.log(beers);
                    console.log(checkins);


                    styles = d3.nest()
                    .key(function(d) {
                      return d.beer_style;
                    })
                    .rollup(function(d) {
                      return d3.sum(d, function(g) {
                        return g.count;
                      });
                    })
                    .entries(beers);

                    console.log(styles);

                    draw_plot("venues", venues, "count", "venue_name");
                    draw_plot("breweries", breweries, "count", "brewery_name");
                    draw_plot("beers", beers, "count", "beer_name");
                    draw_plot("styles", styles, "values", "key");
                })
        }();
    </script>
</body>
</html>